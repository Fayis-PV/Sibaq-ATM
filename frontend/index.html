<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATM Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            background-color: #f2f2f2;
            border: 1px solid #ccc;
        }

        #card {
            margin-top: 20px;
            padding: 10px;
            background-color: #f2f2f2;
            border: 1px solid #ccc;
        }

        #error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <h1>ATM Simulation</h1>
    <div id="status">Card Status: Not Inserted</div>
    <div id="result"></div>
    <div id="card"></div>

    <script>
        const url = 'http://localhost:5000/';
        const api_url = 'https://result.sibaq.in/search?student=';
    
        // Fetch Card State from Backend
        async function fetchCardState() {
            try {
                const response = await fetch(url + 'cardstate');
                if (!response.ok) throw new Error('Failed to fetch card state');
                const data = await response.json();
                return data.card_inserted;
            } catch (error) {
                console.error('Error fetching card state:', error);
                return null;
            }
        }
    
        // Fetch Leaderboard from Backend
        async function fetchLeaderboard() {
            try {
                const response = await fetch(url + 'leaderboard');
                if (!response.ok) throw new Error('Failed to fetch leaderboard');
                const data = await response.json();
                console.log("Leaderboard:", data);
                document.getElementById("result").innerHTML = JSON.stringify(data, null, 2);
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
                document.getElementById("result").innerHTML = `<div id="error">Error: Unable to fetch leaderboard.</div>`;
            }
        }
    
        // Process Barcode via Backend
        async function processBarcode(barcode) {
            try {
                const response = await fetch(url + 'process_barcode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ barcode })
                });
                const data = await response.json();
                document.getElementById("result").innerHTML = data.message || "Processed successfully.";
            } catch (error) {
                console.error('Error processing barcode:', error);
                document.getElementById("result").innerHTML = `<div id="error">Error: Unable to process barcode.</div>`;
            }
        }
    
        // Simulate Barcode Input
        function getBarcode() {
            return new Promise((resolve) => {
                let barcode = '';
                const timeout = setTimeout(() => {

                    resolve(null);
                }, 10000); // 10 seconds timeout
    
                const onKeyPress = (event) => {
                    if (event.key === 'Enter') {
                        clearTimeout(timeout);
                        document.removeEventListener('keydown', onKeyPress);
                        resolve(barcode);
                    } else {
                        barcode += event.key;
                    }
                };
    
                document.addEventListener('keydown', onKeyPress);
            });
        }
    
        // Auto Process Barcode
        async function autoProcessBarcode() {
            document.getElementById("result").innerHTML = "Checking for candidate details...";
            const barcode = await getBarcode();
            if (barcode) {
            processBarcode(barcode);
            } else {
            document.getElementById("result").innerHTML = `<div id="error">Error: Barcode reading timed out.</div>`;
            
            }
        }

        async function autoProcessBarcode() {
            document.getElementById("result").innerHTML = "Checking for candidate details...";
            const barcode = await getBarcode();
            if (barcode) {
                processBarcode(barcode);
            } else {
                document.getElementById("result").innerHTML = `<div id="error">Error: Barcode reading timed out.</div>`;
            }
        }
    
        // Card State Handling
        let cardInserted = false;
    
        function updateCardStatus(newState) {
            const statusDiv = document.getElementById("status");
            cardInserted = newState;
    
            if (cardInserted) {
                statusDiv.innerHTML = "Card Status: Inserted";
                autoProcessBarcode();
            } else {
                statusDiv.innerHTML = "Card Status: Not Inserted";
                fetchLeaderboard();
            }
        }
    
        async function checkCardState() {
            const newCardState = await fetchCardState();
            if (newCardState === null) {
                document.getElementById("status").innerHTML = `<div id="error">Error: Unable to fetch card state.</div>`;
                return;
            }
    
            if (newCardState !== cardInserted) {
                updateCardStatus(newCardState);
            }
        }
    
        // Periodically Check Card State
        setInterval(checkCardState, 2000);
    </script>    

</body>

</html>